---
# tasks file for install-kube

#Disable the Swap

- name: Create a temp directory
  file:
    path: "{{  tempdir  }}"
    state: directory


- name: Disable swap
  command: swapoff -a
  register: swapstatus
  failed_when: swapstatus.stdout is not defined
  changed_when: swapstatus.stdout is defined and swapstatus |length > 0


- name: Comment swap in fstab
  replace:
    path: /etc/fstab
    regexp: '^(.+? sswap s+sw s+.*)$'
    replace: '#  1'
  notify: restart_system

#install docker
- name: Remove old packages to prepare for Docker installation
  yum:
    name: "{{  item  }}"
    state: removed
  loop:
    - docker
    - docker-client
    - docker-client-latest
    - docker-common
    - docker-latest
    - docker-latest-logrotate
    - docker-logrotate
    - docker-engine



- name: Install yum updates
  yum: update_cache=yes
  when: ansible_os_family == "RedHat"


# - name: Add Docker stable yum repository
#   yum_repository:
#     name: DockerRepo
#     description: Docker YUM repo
#     baseurl: https://download.docker.com/linux/centos/docker-ce.repo
#

- name: Install Utilities required for Docker
  yum:
    name: "{{  item  }}"
    state: latest
  loop:
    - yum-utils
    - device-mapper-persistent-data
    - lvm2
    # - docker.io


# - name: Add Docker repo
#   get_url:
#     url: https://download.docker.com/linux/centos/docker-ce.repo
#     dest: /etc/yum.repos.d/docer-ce.repo
#   become: yes
#
# - name: Enable Docker Edge repo
#   ini_file:
#     dest: /etc/yum.repos.d/docer-ce.repo
#     section: 'docker-ce-edge'
#     option: enabled
#     value: 0
#   become: yes


# - name: Enable nighly repos for Docker
#   yum_repository:
#     name: "{{  item  }}"
#     enabled: yes
#   loop:
#     - docker-ce-nightly
#     - docker-ce-test
#   when: enablenightly


- name: Install Docker
  yum:
    name: "{{  item  }}"
    state: latest
  loop:
    - docker-ce-18.06
    - docker-ce-cli
    - containerd.io

- name: Start Docker
  service:
    name: docker
    state: started


- name: Verify Docker installation
  command: docker --version
  register: dockerversion
  changed_when: dockerversion.stdout | length > 0
  failed_when: dockerversion.stdout | length <= 0




- name: Add Kubernetes yum repository
  yum_repository:
    name: kubernetes
    description: kubernetes YUM repo
    baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
    gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
    enabled: yes

- name: Disable SELinux
  selinux:
    state: permissive


- name: Install Kubernetes
  yum:
    name: "{{  item  }}"
    state: latest
    disable_excludes: kubernetes
  loop:
    - kubelet
    - kubeadm
    - kubectl


- name: Enable kubelet
  service:
    name: kubelet
    arguments: --now
    enabled: yes


- name: Remove the temp directory
  file:
    path: "{{  tempdir  }}"
    state: absent

# - name:
